<!DOCTYPE html>
<html>
<head>
    <title>Gerador de Or√ßamentos - Tableau WDC</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Tableau WDC API -->
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js" type="text/javascript"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        button {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }
        
        button:hover {
            background: #5a6fd8;
        }
        
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .endpoints {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .endpoints h3 {
            margin-top: 0;
            color: #333;
        }
        
        .endpoint-item {
            margin: 10px 0;
            padding: 8px;
            background: white;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Gerador de Or√ßamentos</h1>
        <h2 style="text-align: center; color: #666;">Tableau Web Data Connector</h2>
        
        <div class="info">
            <strong>üìä Conecte seus dados de or√ßamentos diretamente ao Tableau!</strong><br>
            Este conector puxa dados em tempo real da API de analytics do sistema.
        </div>
        
        <div class="form-group">
            <label for="apiUrl">üåê URL da API:</label>
            <input type="text" id="apiUrl" value="http://localhost:5000" placeholder="http://localhost:5000">
        </div>
        
        <div class="form-group">
            <label for="dataSource">üìã Fonte de Dados:</label>
            <select id="dataSource">
                <option value="summary">Resumo Analytics (KPIs principais)</option>
                <option value="detailed-jobs">Trabalhos Detalhados (Lista completa)</option>
                <option value="time-series">S√©rie Temporal (Dados hist√≥ricos)</option>
                <option value="kpis">KPIs Executivos (M√©tricas estrat√©gicas)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="refreshRate">‚è±Ô∏è Taxa de Atualiza√ß√£o:</label>
            <select id="refreshRate">
                <option value="300">5 minutos</option>
                <option value="600">10 minutos</option>
                <option value="1800">30 minutos</option>
                <option value="3600">1 hora</option>
            </select>
        </div>
        
        <button id="testConnection">üîç Testar Conex√£o</button>
        <button id="connectBtn" disabled>üìä Conectar ao Tableau</button>
        
        <div id="status"></div>
        
        <div class="endpoints">
            <h3>üì° Endpoints Dispon√≠veis:</h3>
            <div class="endpoint-item">/api/analytics/summary - M√©tricas resumidas</div>
            <div class="endpoint-item">/api/analytics/detailed-jobs - Lista de trabalhos</div>
            <div class="endpoint-item">/api/analytics/time-series - Dados temporais</div>
            <div class="endpoint-item">/api/analytics/kpis - KPIs executivos</div>
        </div>
    </div>

    <script>
        (function() {
            const myConnector = tableau.makeConnector();
            let apiBaseUrl = '';
            let selectedDataSource = '';
            
            // Configura√ß√£o inicial
            document.addEventListener('DOMContentLoaded', function() {
                const testBtn = document.getElementById('testConnection');
                const connectBtn = document.getElementById('connectBtn');
                const statusDiv = document.getElementById('status');
                
                // Teste de conex√£o
                testBtn.addEventListener('click', function() {
                    const apiUrl = document.getElementById('apiUrl').value;
                    testApiConnection(apiUrl, statusDiv, connectBtn);
                });
                
                // Conectar ao Tableau
                connectBtn.addEventListener('click', function() {
                    apiBaseUrl = document.getElementById('apiUrl').value;
                    selectedDataSource = document.getElementById('dataSource').value;
                    
                    // Configurar conector
                    tableau.connectionName = "Gerador de Or√ßamentos - " + selectedDataSource;
                    tableau.submit();
                });
            });
            
            // Fun√ß√£o para testar API
            function testApiConnection(apiUrl, statusDiv, connectBtn) {
                statusDiv.innerHTML = '<div class="status">üîç Testando conex√£o...</div>';
                
                fetch(apiUrl + '/health')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'OK') {
                            statusDiv.innerHTML = '<div class="status success">‚úÖ Conex√£o bem-sucedida! API funcionando.</div>';
                            connectBtn.disabled = false;
                        } else {
                            throw new Error('API retornou status inv√°lido');
                        }
                    })
                    .catch(error => {
                        statusDiv.innerHTML = '<div class="status error">‚ùå Erro na conex√£o: ' + error.message + '</div>';
                        connectBtn.disabled = true;
                    });
            }
            
            // Schema dos dados
            myConnector.getSchema = function(schemaCallback) {
                const dataSource = selectedDataSource;
                let schema = [];
                
                if (dataSource === 'summary') {
                    schema = [{
                        id: "summary_analytics",
                        alias: "Resumo Analytics",
                        columns: [
                            {id: "total_quotes", dataType: tableau.dataTypeEnum.int, alias: "Total Or√ßamentos"},
                            {id: "total_closed_jobs", dataType: tableau.dataTypeEnum.int, alias: "Trabalhos Fechados"},
                            {id: "conversion_rate", dataType: tableau.dataTypeEnum.float, alias: "Taxa Convers√£o (%)"},
                            {id: "total_revenue", dataType: tableau.dataTypeEnum.float, alias: "Receita Total"},
                            {id: "total_hours", dataType: tableau.dataTypeEnum.int, alias: "Total Horas"},
                            {id: "avg_hourly_rate", dataType: tableau.dataTypeEnum.float, alias: "Taxa/Hora M√©dia"},
                            {id: "avg_project_value", dataType: tableau.dataTypeEnum.float, alias: "Valor M√©dio Projeto"}
                        ]
                    }];
                } else if (dataSource === 'detailed-jobs') {
                    schema = [{
                        id: "detailed_jobs",
                        alias: "Trabalhos Detalhados",
                        columns: [
                            {id: "id", dataType: tableau.dataTypeEnum.string, alias: "ID"},
                            {id: "serviceType", dataType: tableau.dataTypeEnum.string, alias: "Tipo Servi√ßo"},
                            {id: "location", dataType: tableau.dataTypeEnum.string, alias: "Localiza√ß√£o"},
                            {id: "budgetTier", dataType: tableau.dataTypeEnum.string, alias: "Faixa Or√ßamento"},
                            {id: "urgency", dataType: tableau.dataTypeEnum.string, alias: "Urg√™ncia"},
                            {id: "total_cost", dataType: tableau.dataTypeEnum.float, alias: "Custo Total"},
                            {id: "total_hours", dataType: tableau.dataTypeEnum.int, alias: "Total Horas"},
                            {id: "hourly_rate", dataType: tableau.dataTypeEnum.float, alias: "Taxa/Hora"},
                            {id: "isClosed", dataType: tableau.dataTypeEnum.bool, alias: "Fechado"},
                            {id: "createdAt", dataType: tableau.dataTypeEnum.datetime, alias: "Criado Em"},
                            {id: "closedAt", dataType: tableau.dataTypeEnum.datetime, alias: "Fechado Em"},
                            {id: "description", dataType: tableau.dataTypeEnum.string, alias: "Descri√ß√£o"}
                        ]
                    }];
                } else if (dataSource === 'time-series') {
                    schema = [{
                        id: "time_series",
                        alias: "S√©rie Temporal",
                        columns: [
                            {id: "date", dataType: tableau.dataTypeEnum.date, alias: "Data"},
                            {id: "jobs_closed", dataType: tableau.dataTypeEnum.int, alias: "Trabalhos Fechados"},
                            {id: "revenue", dataType: tableau.dataTypeEnum.float, alias: "Receita"},
                            {id: "hours", dataType: tableau.dataTypeEnum.int, alias: "Horas"}
                        ]
                    }];
                } else if (dataSource === 'kpis') {
                    schema = [{
                        id: "kpis",
                        alias: "KPIs Executivos",
                        columns: [
                            {id: "monthly_revenue", dataType: tableau.dataTypeEnum.float, alias: "Receita Mensal"},
                            {id: "monthly_jobs", dataType: tableau.dataTypeEnum.int, alias: "Trabalhos Mensais"},
                            {id: "avg_days_to_close", dataType: tableau.dataTypeEnum.float, alias: "Dias M√©dios Fechamento"},
                            {id: "total_pipeline_value", dataType: tableau.dataTypeEnum.float, alias: "Valor Pipeline Total"}
                        ]
                    }];
                }
                
                schemaCallback(schema);
            };
            
            // Buscar dados da API
            myConnector.getData = function(table, doneCallback) {
                const apiUrl = apiBaseUrl + '/api/analytics/' + selectedDataSource;
                
                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        let tableData = [];
                        
                        if (selectedDataSource === 'summary') {
                            tableData = [data.summary];
                        } else if (selectedDataSource === 'detailed-jobs') {
                            tableData = data.jobs.map(job => ({
                                id: job.id,
                                serviceType: job.serviceType,
                                location: job.location,
                                budgetTier: job.budgetTier,
                                urgency: job.urgency,
                                total_cost: job.quote.total_cost,
                                total_hours: job.quote.total_hours,
                                hourly_rate: job.quote.hourly_rate,
                                isClosed: job.isClosed,
                                createdAt: job.createdAt,
                                closedAt: job.closedAt,
                                description: job.description
                            }));
                        } else if (selectedDataSource === 'time-series') {
                            tableData = data.time_series;
                        } else if (selectedDataSource === 'kpis') {
                            tableData = [data.kpis];
                        }
                        
                        table.appendRows(tableData);
                        doneCallback();
                    })
                    .catch(error => {
                        tableau.abortWithError("Erro ao buscar dados: " + error.message);
                    });
            };
            
            // Registrar conector
            tableau.registerConnector(myConnector);
        })();
    </script>
</body>
</html>